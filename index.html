<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Classroom Game Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <h1>Classroom Game Platform • <span id="moduleName">None</span></h1>
    <div class="card">
      <div class="row">
        <div>
          <label>Room Code</label>
          <div class="pill"><b id="roomCode">—</b></div>
        </div>
        <div style="flex:1"></div>
        <div>
          <label>Module</label>
          <select id="moduleSelect">
            <option value="buzzer">Quick Buzzer</option>
            <option value="trashdash">Trash Dash</option>
          </select>
        </div>
        <div>
          <label>Locale</label>
          <select id="localeSelect">
            <option value="en">English</option>
            <option value="ru">Русский</option>
          </select>
        </div>
        <div><button id="newRoomBtn">New Room</button></div>
        <div><button id="startBtn">Start</button></div>
        <div><button id="endBtn">End</button></div>
      </div>
      <div class="small">Controllers open: <code id="controllerUrl">—</code></div>
    </div>

    <div id="screenArea" class="card" style="margin-top:12px;">
      <canvas id="gameCanvas" width="960" height="540" class="canvas"></canvas>
      <div id="buzzerArea" style="display:none;">
        <h2>Buzzer</h2>
        <div id="buzzLog" class="small"></div>
      </div>
    </div>

    <div class="card">
      <h3>Players</h3>
      <div id="players" class="grid"></div>
    </div>

    <hr/>
    <div class="small">Tip: share the URL <code id="joinTip"></code> and room code with students.</div>
  </div>
  <script type="module">
  // Screen (teacher) logic — clean, UTF-8, and Firebase v12.2.1 compatible
  import { db, createRoom, roomRefs, onRoom } from "./js/core.js";
  import * as Buzzer from "./js/modules/buzzer.js";
  import * as TrashDash from "./js/modules/trashdash.js";
  import { ref, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const moduleMap = { buzzer: Buzzer, trashdash: TrashDash };
  let roomCode = null;
  let currentModule = null;
  let roomUnsub = null;

  const el = id => document.getElementById(id);
  const moduleSelect = el("moduleSelect");
  const localeSelect = el("localeSelect");
  const moduleName = el("moduleName");

// Replace your old newRoom function with this one.

async function newRoom(){
  console.log("Attempting to create a new room..."); // Log for debugging

  try {
    // CORRECTED: Call createRoom directly, as it was imported at the top of the script.
    // Also, correctly get both `code` and `roomRef` from the result.
    const { code, roomRef } = await createRoom(moduleSelect.value, localeSelect.value);

    roomCode = code;
    el("roomCode").textContent = code;
    moduleName.textContent = moduleSelect.value;
    const { uiRef, stateRef } = roomRefs(code);

    currentModule = moduleMap[moduleSelect.value];
    await currentModule.init({ code, uiRef, stateRef });

    if (roomUnsub) roomUnsub();
    roomUnsub = onRoom(code, renderRoom);

    const base = location.origin + location.pathname.replace(/index\.html?$/i, "");
    const ctrlUrl = base.endsWith("/") ? base + "controller.html" : base + "/controller.html";
    el("controllerUrl").textContent = ctrlUrl;
    el("joinTip").textContent = ctrlUrl;

    console.log(`Successfully created room: ${code}`); // Success message

  } catch (error) {
    // IMPORTANT: This will catch any error during room creation and log it.
    console.error("Failed to create new room:", error);
    // You could also update the UI to show the error to the user.
    el("roomCode").textContent = "ERROR!";
  }
}

  function renderRoom(room){
    if(!room) return;

    const list = el("players");
    list.innerHTML = "";
    const players = room.players ? Object.entries(room.players) : [];
    players.forEach(([id,p])=>{
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `<b>${p.name||"Player"}</b><br/><span class="small">score: ${p.score||0}</span>`;
      list.appendChild(div);
    });

    if (currentModule && currentModule.draw){
      const canvas = el("gameCanvas");
      const ctx = canvas.getContext("2d");
      currentModule.draw({ room, canvas, ctx });
    }

    el("buzzerArea").style.display = (room.moduleId==="buzzer") ? "block" : "none";
  }

  el("newRoomBtn").onclick = newRoom;
  el("startBtn").onclick = async () => {
    if (!roomCode) return;
    const { phaseRef } = roomRefs(roomCode);
    await set(phaseRef, "playing");
    if (currentModule?.start) currentModule.start({ code: roomCode });
  };
  el("endBtn").onclick = async () => {
    if (!roomCode) return;
    const { phaseRef } = roomRefs(roomCode);
    await set(phaseRef, "ended");
  };

  // bootstrap
  newRoom();
</script>

</body>
</html>
